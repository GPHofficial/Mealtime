<!DOCTYPE html>
<html lang="en">

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-72214160-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-72214160-2');
</script>
<meta name="theme-color" content="#FFFFFF"/>
<link rel="manifest" href="/Mealtime/manifest.json">
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(registration) {
      // Registration was successful
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, function(err) {
      // registration failed :(
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}
</script>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">	
<div class="container-fluid">
<div class="table-responsive">
  <table class="table" id="membertable">
    <thead>
    	<tr>
    		<td></td>
    		<td>Breakfast</td>
    		<td>Lunch</td>
    		<td>Dinner</td>
    	</tr>
    	<tr>
    		<td>Carry forward</td>
    		<td>
    			<div class="checkbox">
				    <label>
				      <input type="checkbox">
				    </label>
			  	</div>
			</td>
    		<td>
    			<div class="checkbox">
				    <label>
				      <input type="checkbox">
				    </label>
			  	</div>
			</td>
			<td>
    			<div class="checkbox">
				    <label>
				      <input type="checkbox">
				    </label>
			  	</div>
			</td>
    	</tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>
  <button id="share">Share on WhatsApp</button>

  <form>
  <div class="form-group">
    <label for="GuardroomName">Guardroom Name</label>
    <input type="text" class="form-control" id="GuardroomName" placeholder="e.g. SGC">
  </div>
  <button type="button" class="btn btn-default" id="saveGuardroomName">Save</button>
</form>

<form>
  <div class="form-group">
    <label for="exampleInputEmail1">Add new member (Rank + Name)</label>
    <input type="text" class="form-control" id="MemberName" placeholder="e.g. CPL Samuel">
  </div>
  <button type="button" class="btn btn-default" id="saveMemberName">Add</button>
</form>


<form>
  <div class="form-group">
    <label>Delete Member</label>
  </div>
	<button type="button" class="btn btn-default" data-toggle="modal" data-target="#deleteModal" id="deleteModalBtn">
  		Delete
	</button>
</form>
</div>
<!-- Button trigger modal -->


<!-- Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModal" >
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Delete Member</h4>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
		  <table class="table" id="deleteTable">
		    <thead>
		    	<tr>
		    		<td>Name</td>
		    		<td>Delete ?</td>
		    	</tr>
		    </thead>
		    <tbody>
		    </tbody>
		  </table>
		</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger" id="deleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
var checkbox = '<td><div class="checkbox"><label><input type="checkbox"></label></div></td>';
var checkboxChecked = '<td><div class="checkbox"><label><input type="checkbox" checked></label></div></td>';


$("#membertable>thead>tr:last").click(function(e){     //saves member state

	if(this.cells[1].children[0].children[0].children[0].checked)
		carryForward(1)
	if(this.cells[2].children[0].children[0].children[0].checked)
		carryForward(2)
	if(this.cells[3].children[0].children[0].children[0].checked)
		carryForward(3)
	this.cells[1].children[0].children[0].children[0].checked = false;
	this.cells[2].children[0].children[0].children[0].checked = false;
	this.cells[3].children[0].children[0].children[0].checked = false;
});

function carryForward(Flag){
	var memberstable = $("#membertable").find("tbody>tr");
	for (var i = 0;i<memberstable.length;i++){
		var membername = memberstable[i].cells[0].innerText;

		if(Flag == 1){//breakfastToLunch
			memberstable[i].cells[2].children[0].children[0].children[0].checked = memberstable[i].cells[1].children[0].children[0].children[0].checked;
			
		}
		if(Flag == 2){//lunchToDinner
			memberstable[i].cells[3].children[0].children[0].children[0].checked = memberstable[i].cells[2].children[0].children[0].children[0].checked;
			
		}
		if(Flag == 3){//dinnerToBreakfast
			memberstable[i].cells[1].children[0].children[0].children[0].checked = memberstable[i].cells[3].children[0].children[0].children[0].checked;
			memberstable[i].cells[2].children[0].children[0].children[0].checked = false;
			memberstable[i].cells[3].children[0].children[0].children[0].checked = false;
			
		}
		
		
	}
	if(Flag == 1){//breakfastToLunch
		alert("Breakfast carried forward to Lunch")
	}
	if(Flag == 2){//breakfastToLunch
		alert("Lunch carried forward to Dinner")
	}
	if(Flag == 3){//breakfastToLunch
		alert("Dinner carried forward to Breakfast")
	}
	
	saveTableState();
}

function saveTableState(){
	var memberstable = $("#membertable").find("tbody>tr");
  	for (var i = 0;i<memberstable.length;i++){
		var membername = memberstable[i].cells[0].innerText;
		var breakfast = memberstable[i].cells[1].children[0].children[0].children[0].checked
		var lunch = memberstable[i].cells[2].children[0].children[0].children[0].checked
		var dinner = memberstable[i].cells[3].children[0].children[0].children[0].checked
		var member = {"name": membername, "breakfast": breakfast, "lunch": lunch, "dinner": dinner};
		replaceMemberStorageState(member)
	}
}

//Make it possible to update 1 row
$("#membertable>tbody").click(function(e){     //saves member state
	console.log("tbody")
	saveTableState();
});

function replaceMemberStorageState(updateMember){
	var stateJSONString = localStorage.getItem('membersState');
  	if(stateJSONString) //exists
	{
		var StateArray = JSON.parse(stateJSONString);
		var memberPosition = -1;
		for(var i =0;i<StateArray.length;i++){
			if(StateArray[i]["name"] ==updateMember["name"]){
				memberPosition = i;
				break;
			}
		}
		if (memberPosition > -1) {
		    StateArray.splice(memberPosition, 1);
		}
		StateArray.splice( 0, 0, updateMember );
		localStorage.setItem('membersState', JSON.stringify(StateArray));
	}else{
		localStorage.setItem('membersState', JSON.stringify([updateMember]));
	}
}

function initializePage(){
	$('#membertable > tbody').html('');
	var membersJSONString = localStorage.getItem('membersState');
  	if(membersJSONString) //exists
	{
		var members = JSON.parse(membersJSONString);
		for(var i = 0;i<members.length;i++){
			var breakfastCheckbox = members[i].breakfast ? checkboxChecked : checkbox;
			var lunchCheckbox = members[i].lunch ? checkboxChecked : checkbox;
			var dinnerCheckbox = members[i].dinner ? checkboxChecked : checkbox;
			$('#membertable > tbody:last-child').append('<tr><td>' + members[i]["name"] + '</td>' + breakfastCheckbox + lunchCheckbox + dinnerCheckbox + '</tr>');
		}
	}
	var guardroomname = JSON.parse(localStorage.getItem('name'));
	if(guardroomname){
		$("#GuardroomName").val(guardroomname);
	}
	
}

$( "#saveMemberName" ).click(function() {
  	var name = $("#MemberName").val();
  	if(name === ""){
  		alert("nameless boi")
  		return;
  	}
  	var Member = {"name":name,"breakfast":false,"lunch":false,"dinner":false};
  	var stateJSONString = localStorage.getItem('membersState');
  	if(stateJSONString) //exists
	{
		var StateArray = JSON.parse(stateJSONString);
		var memberPosition = -1;
		for(var i =0;i<StateArray.length;i++){
			if(StateArray[i]["name"] ==Member["name"]){
				alert("Member already exists")
				return;
			}
		}
	}
	$('#membertable > tbody:last-child').append('<tr><td>' + name + '</td>' + checkbox + checkbox + checkbox + '</tr>');
	saveTableState();
	$("#MemberName").val("");
});

//TODO
//Edge case of present member but all meals undone not resolved
//member management &sort
$("#share").click(function() {

	var guardroomname = JSON.parse(localStorage.getItem('name'));
	if(!guardroomname){
		alert("no guardroom name registered")
		return;
	}

	var memberstable = $("#membertable").find("tbody>tr");
	var membersStatus = "";
	for (var i = 0;i<memberstable.length;i++){
		var membername = memberstable[i].cells[0].innerText;
		var breakfast = memberstable[i].cells[1].children[0].children[0].children[0].checked ? "done" : "x"
		var lunch = memberstable[i].cells[2].children[0].children[0].children[0].checked ? "done" : "x"
		var dinner = memberstable[i].cells[3].children[0].children[0].children[0].checked ? "done" : "x"
		if(!(breakfast == "x" && lunch == "x" && dinner == "x" )){
			membersStatus += membername + " (" + breakfast + " breakfast, " + lunch + " lunch, " + dinner + " dinner) \n";
		}
		
	}

	var today = new Date();
	var options = {  year: '2-digit', month: '2-digit', day: '2-digit' };

	var text = guardroomname + " " + today.toLocaleDateString('en-SG', options).split('/').join('') + " \n" + membersStatus;

	window.location.href = "https://api.whatsapp.com/send?text=" + encodeURIComponent(text);
	console.log(text);
});

$( "#saveGuardroomName" ).click(function() {
  	var name = $("#GuardroomName").val();
	localStorage.setItem('name', JSON.stringify(name));
});

$("#deleteModalBtn").click(function(e){
	var membersJSONString = localStorage.getItem('membersState');
  	if(membersJSONString) //exists
	{
		var members = JSON.parse(membersJSONString);
		$('#deleteTable > tbody').html('')
		for(var i = 0;i<members.length;i++){
			$('#deleteTable > tbody:last-child').append('<tr><td>' + members[i].name + '</td>' + checkbox + '</tr>');
		}
	}
})

$("#deleteBtn").click(function(e){
	var memberChange = false;
	var memberstable = $("#deleteTable").find("tbody>tr");
	
	
	for (var i = 0;i<memberstable.length;i++){
		var deleteMember = memberstable[i].cells[1].children[0].children[0].children[0].checked;
		var membername = memberstable[i].cells[0].innerText;
		if(deleteMember){
				var membersJSONString = localStorage.getItem('membersState');
			  	if(!membersJSONString) //exists
				{
					alert("no members found");
					return;
				}
				var StateArray = JSON.parse(membersJSONString);
				var memberPosition = -1;
				for(var j =0;j<StateArray.length;j++){
					if(StateArray[j]["name"] == membername){
						memberPosition = j;
						break;
					}
				}
				if (memberPosition > -1) {
					memberChange = true;
				    StateArray.splice(memberPosition, 1);
				    console.log('test1')
				    localStorage.setItem('membersState', JSON.stringify(StateArray));
				}
				console.log('test4')
		}
		console.log('test5')
	}
	if(memberChange){
		initializePage();
	}
	$("#deleteModal").modal('hide');
});
initializePage();
</script>
</html>
